apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: my-opentelemetry-collector
  namespace: opentelemetry-collector
spec:
  interval: 5m
  releaseName: opentelemetry-collector
  chart:
    spec:
      chart: opentelemetry-collector
      sourceRef:
        kind: HelmRepository
        name: open-telemetry
        namespace: flux-system
      version: 0.73.1
  values:
    mode: deployment
    presets:
      logsCollection:
        enabled: true
        includeCollectorLogs: true
      kubernetesAttributes:
        enabled: true
      kubernetesEvents:
        enabled: true
      clusterMetrics:
        enabled: true
      kubeletMetrics:
        enabled: true
      hostMetrics:
        enabled: true
    resources:
      limits:
        cpu: 256m
        memory: 512Mi
    ports:
      metrics: 
        enabled: true
    podAnnotations:
      prometheus.io/scrape: "true"
      prometheus.io/port: "8888"
      opentelemetry_community_demo: "true"
    config:
      extensions:
        health_check:
          check_collector_pipeline:
            enabled: false
        basicauth/logs:
          client_auth:
            username: 1117173
            password: "glc_eyJvIjoiMTMzODAxOSIsIm4iOiJ0ZXN0LWdyYWZhbmEtZ3JhZmFuYWpoY29kaW5nIiwiayI6ImFPNFFRM1prODV5STBRTjU3ZDNqZVQxOCIsIm0iOnsiciI6InVzIn19"
        basicauth/metrics:
          client_auth:
            username: 2242991
            password: "glc_eyJvIjoiMTMzODAxOSIsIm4iOiJ0ZXN0LWdyYWZhbmEtZ3JhZmFuYWpoY29kaW5nIiwiayI6ImFPNFFRM1prODV5STBRTjU3ZDNqZVQxOCIsIm0iOnsiciI6InVzIn19"
        basicauth/traces:
          client_auth:
            username: 1111488
            password: "glc_eyJvIjoiMTMzODAxOSIsIm4iOiJ0ZXN0LWdyYWZhbmEtZ3JhZmFuYWpoY29kaW5nIiwiayI6ImFPNFFRM1prODV5STBRTjU3ZDNqZVQxOCIsIm0iOnsiciI6InVzIn19"
      service:
        pipelines:
          logs:
            receivers:
              - filelog
              - otlp
            processors:
              - memory_limiter
              - batch
              - k8sattributes/labels
              - resource/loki_add_hints
              - attributes/loki_add_hints
            exporters:
              - loki
              - debug/logs
          metrics:
            receivers:
              - otlp
              - spanmetrics
              - servicegraph
            processors:
              - memory_limiter
              - filter/ottl
              - transform
              - resource
              - batch
            exporters:
              - prometheusremotewrite
              - debug/metrics
          traces:
            receivers:
              - otlp
            processors:
              - memory_limiter
              - transform
              - resource
              - batch
            exporters:
              - otlp
              - debug/traces
              - spanmetrics
              - servicegraph
        extensions:
          - basicauth/logs
          - basicauth/metrics
          - basicauth/traces
          - health_check
      receivers:
        otlp:
          protocols:
            grpc:
              endpoint: ${env:MY_POD_IP}:4317
            http:
              endpoint: ${env:MY_POD_IP}:4318
              cors:
                allowed_origins:
                  - "http://*"
                  - "https://*"
        k8s_cluster:
          collection_interval: 60s
        kubeletstats:
          collection_interval: 60s
        hostmetrics:
          collection_interval: 60s
        prometheus:
          config:
            scrape_configs:
              - job_name: 'opentelemetry-collector'
                scrape_interval: 60s
                static_configs:
                  - targets:
                      - opentelemetry-collector:8888
      processors:
        memory_limiter:
          check_interval: 30s
          limit_percentage: 50
          spike_limit_percentage: 30
        filter/ottl:
          error_mode: ignore
          metrics:
            metric:
              - 'name == "queueSize"'
              - 'name == "rpc.server.duration"'
        transform:
          metric_statements:
            - context: metric
              statements:
                - set(description, "") where name == "queueSize"
                - set(description, "") where name == "rpc.server.duration"
                - set(description, "") where name == "http.client.duration"
                - keep_keys(resource.attributes, ["service.name", "span.name", "span.kind", "status.code", "service.instance.id"]) where name == "traces.spanmetrics.duration"
                - set(name, "traces.spanmetrics.latency") where name == "traces.spanmetrics.duration"
          trace_statements:
            - context: span
              statements:
                - replace_pattern(name, "^HTTP\\s+([A-Z]+)", "$$1")
        resource:
          attributes:
          - key: service.instance.id
            from_attribute: k8s.pod.uid
            action: insert
          
        k8sattributes/labels:
          auth_type: "serviceAccount"
          passthrough: false
          pod_association:
            - sources:
              - from: resource_attribute
                name: k8s.pod.name
            - sources:
              - from: resource_attribute
                name: k8s.namespace.name
            - sources:
              - from: connection
          extract:
            metadata:
              - k8s.pod.name
              - k8s.container.name
              - k8s.deployment.name
              - k8s.node.name
              - k8s.namespace.name
              - k8s.pod.start_time
              - k8s.replicaset.name
              - k8s.daemonset.name
            labels:
              - tag_name: $$1
                key_regex: app.kubernetes.io/(.*)
                from: pod

        resource/loki_add_hints:
          attributes:
            - action: upsert
              key: k8s_cluster_name
              from_attribute: k8s.cluster.name
            - action: upsert
              key: k8s_namespace_name
              from_attribute: k8s.namespace.name
            - action: upsert
              key: k8s_container_name
              from_attribute: k8s.container.name
            - action: upsert
              key: k8s_deployment_name
              from_attribute: k8s.deployment.name
            - action: upsert
              key: k8s_node_name
              from_attribute: k8s.node.name
            - action: insert
              key: loki.resource.labels
              value: "\
                k8s_cluster_name,\
                k8s_namespace_name,\
                k8s_container_name,\
                k8s_node_name,\
                component,\
                instance,\
                name,\
                service_name,\
                service_namespace"

        attributes/loki_add_hints:
          actions:
            - action: upsert
              key: log_iostream
              from_attribute: log.iostream
            - action: insert
              key: loki.attribute.labels
              value: "log_iostream"
      exporters:
        loki:
          endpoint: https://logs-prod-026.grafana.net/loki/api/v1/push
          auth:
            authenticator: basicauth/logs
        prometheusremotewrite:
          resource_to_telemetry_conversion: 
            enabled: true
          endpoint: https://prometheus-prod-41-prod-au-southeast-1.grafana.net/api/prom/push
          auth:
            authenticator: basicauth/metrics
        otlp:
          endpoint: tempo-prod-16-prod-au-southeast-1.grafana.net:443 
          auth:
            authenticator: basicauth/traces
        debug/logs:
          verbosity: debug
        debug/metrics:
          verbosity: debug
        debug/traces:
          verbosity: debug
      connectors:
        spanmetrics:
          histogram:
            unit: s
          namespace: traces.spanmetrics
          metrics_flush_interval: 60s
        servicegraph:
          store:
            ttl: 30s
            max_items: 5000
